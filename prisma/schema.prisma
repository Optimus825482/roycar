generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─── Kimlik Doğrulama ───

model AdminUser {
  id           BigInt   @id @default(autoincrement())
  username     String   @unique
  email        String?
  passwordHash String   @map("password_hash")
  fullName     String   @map("full_name")
  role         String   @default("hr_manager")
  permissions  Json     @default("{\"form_builder\":true,\"ai_chat\":true,\"evaluations\":true,\"screening\":true,\"data_import\":true,\"import_delete\":false,\"settings\":false,\"user_management\":false}")
  isActive     Boolean  @default(true) @map("is_active")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz

  chatSessions ChatSession[]
  createdSessions    EvaluationSession[] @relation("SessionCreator")
  createdEvaluations Evaluation[]        @relation("EvaluationCreator")

  @@map("admin_users")
}

// ─── Departmanlar ───

model Department {
  id        BigInt   @id @default(autoincrement())
  name      String   @unique
  isActive  Boolean  @default(true) @map("is_active")
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz

  applications Application[]
  screeningCriteria ScreeningCriteria[]

  @@map("departments")
}

model ScreeningCriteria {
  id           BigInt   @id @default(autoincrement())
  name         String
  description  String?
  departmentId BigInt?  @map("department_id")
  formConfigId BigInt?  @map("form_config_id")
  isActive     Boolean  @default(true) @map("is_active")
  criteriaRules Json    @default("[]") @map("criteria_rules")
  passThreshold Int     @default(60) @map("pass_threshold")
  useAiAssist  Boolean  @default(false) @map("use_ai_assist")
  aiPrompt     String?  @map("ai_prompt")
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime @default(now()) @map("updated_at") @db.Timestamptz

  department Department? @relation(fields: [departmentId], references: [id])
  formConfig FormConfig? @relation(fields: [formConfigId], references: [id])
  results    ScreeningResult[]

  @@index([departmentId])
  @@index([formConfigId])
  @@index([isActive])
  @@map("screening_criteria")
}

// ─── Ön Eleme Sonuçları ───

model ScreeningResult {
  id            BigInt   @id @default(autoincrement())
  applicationId BigInt   @map("application_id")
  criteriaId    BigInt   @map("criteria_id")
  passed        Boolean
  score         Int      @default(0)
  details       Json     @default("{}")
  screenedAt    DateTime @default(now()) @map("screened_at") @db.Timestamptz

  application Application       @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  criteria    ScreeningCriteria  @relation(fields: [criteriaId], references: [id])

  @@unique([applicationId, criteriaId])
  @@index([applicationId])
  @@index([criteriaId])
  @@map("screening_results")
}


// ─── Form Yapılandırması ───

model FormConfig {
  id          BigInt   @id @default(autoincrement())
  title       String
  mode        String   @default("static")
  isPublished Boolean  @default(false) @map("is_published")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  questions    Question[]
  applications Application[]
  screeningCriteria ScreeningCriteria[]

  @@index([isPublished, isActive])
  @@map("form_configs")
}

// ─── Soru Tanımları ───

model Question {
  id           BigInt   @id @default(autoincrement())
  formConfigId BigInt   @map("form_config_id")
  groupLabel   String?  @map("group_label")
  questionText String   @map("question_text")
  questionType String   @map("question_type")
  isRequired   Boolean  @default(true) @map("is_required")
  sortOrder    Int      @map("sort_order")
  options      Json?
  validation   Json?
  metadata     Json?
  createdAt    DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt    DateTime @updatedAt @map("updated_at") @db.Timestamptz

  formConfig      FormConfig           @relation(fields: [formConfigId], references: [id], onDelete: Cascade)
  images          QuestionImage[]
  branchingRules  BranchingRule[]      @relation("SourceQuestion")
  targetedByRules BranchingRule[]      @relation("TargetQuestion")
  responses       ApplicationResponse[]

  @@index([formConfigId, sortOrder])
  @@map("questions")
}

// ─── Soru Görselleri ───

model QuestionImage {
  id         BigInt   @id @default(autoincrement())
  questionId BigInt   @map("question_id")
  filePath   String   @map("file_path")
  fileName   String   @map("file_name")
  mimeType   String   @map("mime_type")
  sortOrder  Int      @default(0) @map("sort_order")
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz

  question Question @relation(fields: [questionId], references: [id], onDelete: Cascade)

  @@index([questionId])
  @@map("question_images")
}

// ─── Koşullu Dallanma Kuralları ───

model BranchingRule {
  id               BigInt   @id @default(autoincrement())
  sourceQuestionId BigInt   @map("source_question_id")
  targetQuestionId BigInt   @map("target_question_id")
  conditionLogic   String   @default("AND") @map("condition_logic")
  conditions       Json
  priority         Int      @default(0)
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz

  sourceQuestion Question @relation("SourceQuestion", fields: [sourceQuestionId], references: [id], onDelete: Cascade)
  targetQuestion Question @relation("TargetQuestion", fields: [targetQuestionId], references: [id], onDelete: Cascade)

  @@index([sourceQuestionId])
  @@index([targetQuestionId])
  @@map("branching_rules")
}


// ─── Başvurular ───

model Application {
  id              BigInt   @id @default(autoincrement())
  applicationNo   String   @unique @map("application_no")
  formConfigId    BigInt   @map("form_config_id")
  departmentId    BigInt?  @map("department_id")
  positionId      BigInt?  @map("position_id")
  positionTitle   String?  @map("position_title")
  fullName        String   @map("full_name")
  email           String
  phone           String
  photoPath       String?  @map("photo_path")
  status          String   @default("new")
  submittedAt     DateTime @default(now()) @map("submitted_at") @db.Timestamptz
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz
  responseSummary Json?    @map("response_summary")
  importLogId     BigInt?  @map("import_log_id")

  formConfig   FormConfig           @relation(fields: [formConfigId], references: [id])
  department   Department?          @relation(fields: [departmentId], references: [id])
  responses    ApplicationResponse[]
  evaluations  Evaluation[]
  importLog    ImportLog?           @relation(fields: [importLogId], references: [id])
  screeningResults ScreeningResult[]
  fieldValues  ApplicationFieldValue[]
  groupMembers CandidateGroupMember[]

  @@index([email, departmentId])
  @@index([status])
  @@index([departmentId])
  @@index([positionId])
  @@index([submittedAt])
  @@index([fullName])
  @@map("applications")
}

// ─── Dinamik Alan Tanımları (Import Sütun Başlıkları) ───

model ImportFieldDefinition {
  id             BigInt   @id @default(autoincrement())
  fieldName      String   @map("field_name")
  normalizedName String   @unique @map("normalized_name")
  fieldCategory  String   @default("general") @map("field_category")
  dataType       String   @default("text") @map("data_type")
  isActive       Boolean  @default(true) @map("is_active")
  usageCount     Int      @default(0) @map("usage_count")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz

  values ApplicationFieldValue[]

  @@index([fieldCategory])
  @@index([isActive])
  @@map("import_field_definitions")
}

// ─── Başvuru Dinamik Alan Değerleri ───

model ApplicationFieldValue {
  id                BigInt   @id @default(autoincrement())
  applicationId     BigInt   @map("application_id")
  fieldDefinitionId BigInt   @map("field_definition_id")
  value             String   @map("value")
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz

  application     Application          @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  fieldDefinition ImportFieldDefinition @relation(fields: [fieldDefinitionId], references: [id])

  @@unique([applicationId, fieldDefinitionId])
  @@index([applicationId])
  @@index([fieldDefinitionId])
  @@index([value])
  @@map("application_field_values")
}

// ─── Başvuru Yanıtları ───

model ApplicationResponse {
  id            BigInt   @id @default(autoincrement())
  applicationId BigInt   @map("application_id")
  questionId    BigInt   @map("question_id")
  answerText    String?  @map("answer_text")
  answerJson    Json?    @map("answer_json")
  answerFile    String?  @map("answer_file")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz

  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  question    Question    @relation(fields: [questionId], references: [id])

  @@unique([applicationId, questionId])
  @@index([applicationId])
  @@index([questionId])
  @@map("application_responses")
}

// ─── Değerlendirme Oturumları ───

model EvaluationSession {
  id          BigInt   @id @default(autoincrement())
  label       String?
  description String?
  criteria    Json     @default("[]")
  status      String   @default("active")
  createdById BigInt?  @map("created_by_id")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  createdBy    AdminUser? @relation("SessionCreator", fields: [createdById], references: [id], onDelete: SetNull)
  evaluations  Evaluation[]
  groupMembers CandidateGroupMember[]

  @@index([status])
  @@index([createdById])
  @@map("evaluation_sessions")
}

// ─── AI Değerlendirme ───

model Evaluation {
  id              BigInt    @id @default(autoincrement())
  applicationId   BigInt    @map("application_id")
  sessionId       BigInt?   @map("session_id")
  overallScore    Int       @map("overall_score")
  status          String    @default("pending")
  report          Json
  rawResponse     String?   @map("raw_response")
  retryCount      Int       @default(0) @map("retry_count")
  customCriteria  Json?     @map("custom_criteria")
  evaluationLabel String?   @map("evaluation_label")
  manualNote      String?   @map("manual_note")
  finalDecision   String?   @map("final_decision")
  createdById     BigInt?   @map("created_by_id")
  evaluatedAt     DateTime? @map("evaluated_at") @db.Timestamptz
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz

  application  Application        @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  session      EvaluationSession?  @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  createdBy    AdminUser?          @relation("EvaluationCreator", fields: [createdById], references: [id], onDelete: SetNull)
  groupMembers CandidateGroupMember[]

  @@index([applicationId])
  @@index([sessionId])
  @@index([status])
  @@index([overallScore])
  @@map("evaluations")
}

// ─── Aday Grupları ───

model CandidateGroup {
  id          BigInt   @id @default(autoincrement())
  name        String
  description String?
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt   DateTime @updatedAt @map("updated_at") @db.Timestamptz

  members CandidateGroupMember[]

  @@map("candidate_groups")
}

model CandidateGroupMember {
  id                  BigInt   @id @default(autoincrement())
  groupId             BigInt   @map("group_id")
  applicationId       BigInt   @map("application_id")
  evaluationSessionId BigInt?  @map("evaluation_session_id")
  evaluationId        BigInt?  @map("evaluation_id")
  notes               String?
  addedAt             DateTime @default(now()) @map("added_at") @db.Timestamptz

  group             CandidateGroup     @relation(fields: [groupId], references: [id], onDelete: Cascade)
  application       Application        @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  evaluationSession EvaluationSession? @relation(fields: [evaluationSessionId], references: [id], onDelete: SetNull)
  evaluation        Evaluation?        @relation(fields: [evaluationId], references: [id], onDelete: SetNull)

  @@unique([groupId, applicationId])
  @@index([groupId])
  @@index([applicationId])
  @@index([evaluationSessionId])
  @@map("candidate_group_members")
}

// ─── AI Sohbet ───

model ChatSession {
  id             BigInt   @id @default(autoincrement())
  adminUserId    BigInt   @map("admin_user_id")
  title          String?
  isArchived     Boolean  @default(false) @map("is_archived")
  contextSummary String?  @map("context_summary")
  summaryUpTo    Int      @default(0) @map("summary_up_to")
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt      DateTime @updatedAt @map("updated_at") @db.Timestamptz

  adminUser AdminUser     @relation(fields: [adminUserId], references: [id])
  messages  ChatMessage[]

  @@index([adminUserId])
  @@index([isArchived])
  @@map("chat_sessions")
}

model ChatMessage {
  id            BigInt   @id @default(autoincrement())
  chatSessionId BigInt   @map("chat_session_id")
  role          String
  content       String
  metadata      Json?
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz

  chatSession ChatSession @relation(fields: [chatSessionId], references: [id], onDelete: Cascade)

  @@index([chatSessionId, createdAt])
  @@map("chat_messages")
}

// ─── Sistem Ayarları ───

model SystemSetting {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt @map("updated_at") @db.Timestamptz

  @@map("system_settings")
}

// ─── Veri Aktarımı ───

model ImportLog {
  id            BigInt    @id @default(autoincrement())
  fileName      String    @map("file_name")
  totalRows     Int       @map("total_rows")
  importedCount Int       @map("imported_count")
  skippedCount  Int       @map("skipped_count")
  errorDetails  Json?     @map("error_details")
  status        String    @default("processing")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz
  completedAt   DateTime? @map("completed_at") @db.Timestamptz

  applications Application[]

  @@map("import_logs")
}


// ─── Pozisyon Varsayılan Özellikleri ───

model PositionDefault {
  id               BigInt   @id @default(autoincrement())
  category         String   // service, bar, banquet, room_service, management
  level            Int      // 1=stratejik, 2=operasyonel, 3=icra
  authorityScore   Int      @default(0) @map("authority_score")
  guestInteraction Int      @default(0) @map("guest_interaction")
  teamSize         Int      @default(1) @map("team_size")
  skills           Json?    // { management, technical, social, physical, crisis }
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime @updatedAt @map("updated_at") @db.Timestamptz

  @@unique([category, level])
  @@index([category])
  @@map("position_defaults")
}

// ─── Pozisyon Şablonları (Seçilebilir Pozisyon Tipleri) ───

model PositionTemplate {
  id               BigInt   @id @default(autoincrement())
  title            String
  titleEn          String?  @map("title_en")
  description      String?
  category         String   @default("service")
  level            Int      @default(3)
  authorityScore   Int      @default(0) @map("authority_score")
  guestInteraction Int      @default(0) @map("guest_interaction")
  teamSize         Int      @default(1) @map("team_size")
  skills           Json?
  sortOrder        Int      @default(0) @map("sort_order")
  isActive         Boolean  @default(true) @map("is_active")
  createdAt        DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt        DateTime @updatedAt @map("updated_at") @db.Timestamptz

  @@unique([title])
  @@index([category])
  @@index([isActive])
  @@map("position_templates")
}

// ─── Organizasyon Şeması ───

model OrgPosition {
  id                BigInt   @id @default(autoincrement())
  title             String
  titleEn           String?  @map("title_en")
  description       String?
  category          String   @default("service") // service, bar, banquet, room_service, management
  level             Int      @default(3) // 1=stratejik, 2=operasyonel, 3=icra
  parentId          BigInt?  @map("parent_id")
  authorityScore    Int      @default(0) @map("authority_score") // 0-100
  guestInteraction  Int      @default(0) @map("guest_interaction") // 0-100
  teamSize          Int      @default(1) @map("team_size")
  skills            Json?    // { management: 0-100, technical: 0-100, social: 0-100, physical: 0-100, crisis: 0-100 }
  sortOrder         Int      @default(0) @map("sort_order")
  isActive          Boolean  @default(true) @map("is_active")
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz

  parent   OrgPosition?  @relation("OrgHierarchy", fields: [parentId], references: [id])
  children OrgPosition[] @relation("OrgHierarchy")

  @@index([category])
  @@index([parentId])
  @@index([level])
  @@map("org_positions")
}
